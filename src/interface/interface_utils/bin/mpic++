#!/bin/bash

WI4MPI_GCONFIG=$( readlink -f $(dirname $0)/../etc/wi4mpi.cfg )
WI4MPI_UCONFIG="~/.wi4mpi.cfg"

usage() {

    cat <<EOF
Usage: mpic++ [MPIC++_OPTION]... SOURCE...

Option:
    -h           the help message
    -show        show the compilations options
    -wi4mpi_default_run_path    set a default MPI conversion
                                for the user application.
                                accepted values :
                                  - OMPI
                                  - INTEL
Influencable variables:
  - WI4MPI_CC                   C compiler
  - WI4MPI_ROOT                 WI4MPI installation root
  - WI4MPI_RUN_MPI_C_LIB        C MPI implementation library 
                                used at runtime
  - WI4MPI_RUN_MPI_F_LIB        Fortran MPI implementation 
                                library used at runtime
EOF

}

showme() {

cat <<EOF

${WI4MPI_CXX} -I${WI4MPI_ROOT}/include -L${WI4MPI_ROOT}/lib -lmpi

EOF

}

showme_static() {

cat <<EOF

${WI4MPI_CXX} -I${WI4MPI_ROOT}/include ${WI4MPI_ROOT}/lib/libmpi.a

EOF

}

default_mode() {
	
	#cat << EOF > wi4mpi_libs_default_paths.c
	
	echo "char wi4mpi_mode[]=\"$wi4mpi_mode\";"	> wi4mpi_libs_default_paths.c
	echo "char wi4mpi_mode_f[]=\"$wi4mpi_mode_f\";"	>> wi4mpi_libs_default_paths.c

	#EOF
		
}

source_default_mode() {
	
	echo "export WI4MPI_RUN_MPI_C_LIB=\"$WI4MPI_RUN_MPI_C_LIB\"" > run_settings.sh
  echo "export WI4MPI_RUN_MPI_F_LIB=\"$WI4MPI_RUN_MPI_F_LIB\"" >> run_settings.sh
	echo $LD_LIBRARY_PATH
	echo "export OLD_LD_LIBRARY_PATH=$LD_LIBRARY_PATH"					>> run_settings.sh
	echo "export LD_LIBRARY_PATH=$WI4MPI_ROOT/lib:$LD_LIBRARY_PATH" >> run_settings.sh

	echo "Please source run_settings.sh to export WI4MPI_RUN_MPI_C_LIB, WI4MPI_RUN_MPI_F_LIB and LD_LIBRARY_PATH ;)"
	echo "To retrieve an healthy environment:"
	echo "unset WI4MPI_RUN_MPI_C_LIB"
	echo "unset WI4MPI_RUN_MPI_F_LIB"
	echo "export LD_LIBRARY_PATH=$LD_LIBRARY_PATH"

}
arg=$@
default_mode_activated=0
static_compilation=0
[[ -f $WI4MPI_GCONFIG ]] && source $WI4MPI_GCONFIG
[[ -f $WI4MPI_UCONFIG ]] && source $WI4MPI_UCONFIG

#wi4mpi_mode and wi4mpi_mode_f are set by WI4MPI_ROOT/etc/wi4mpi.cfg
wi4mpi_run_c_library=$WI4MPI_RUN_MPI_C_LIB;  
wi4mpi_run_f_library=$WI4MPI_RUN_MPI_F_LIB;  

while [[ $# -ge 1 ]]
do
key=$1

case $key in
      -h | --help)
      usage; exit 0;;
      -show )
      showme; exit 0;;
			-show_static )
			showme_static; exit 0;;
			-wi4mpi_default_run_path )
				#echo "default mode"
				if [[ $default_mode_activated -eq 0 ]]; then
					default_mode_activated=1
					#exclude -wi4mpi_default_run_path from arg list passed to WI4MPI_CC
					arg=`echo $arg | sed "s/-wi4mpi_default_run_path//g"`
					#Testing the argument after the option -wi4mpi_default_run_path
					#echo "Default mode choosen : $2"
					if [[ "$2" == "OMPI" ]]; then
						#echo "OMPI"
						wi4mpi_mode=$WI4MPI_ROOT/lib_$2/libwi4mpi_CCC_OMPI.so
						wi4mpi_mode_f=$WI4MPI_ROOT/lib_$2/libwi4mpi_CCC_OMPI.so
						wi4mpi_run_mpi_c_lib=${wi4mpi_run_mpi_c_lib:-${openmpi_default_root}/lib/libmpi.so}
						wi4mpi_run_mpi_f_lib=${wi4mpi_run_mpi_f_lib:-${openmpi_default_root}/lib/libmpi_mpifh.so}
					elif [[ "$2" == "INTEL" ]]; then
						#echo "INTEL"
						wi4mpi_mode=$WI4MPI_ROOT/lib_$2/libwi4mpi_CCC_INTEL.so
						wi4mpi_mode_f=$WI4MPI_ROOT/lib_$2/libwi4mpi_CCC_INTEL.so
						WI4MPI_RUN_MPI_C_LIB=${WI4MPI_RUN_MPI_C_LIB:-${INTELMPI_DEFAULT_ROOT}/lib64/libmpi.so}
						WI4MPI_RUN_MPI_F_LIB=${WI4MPI_RUN_MPI_F_LIB:-${INTELMPI_DEFAULT_ROOT}/lib64/libmpifort.so}
					else
						usage; exit 0;
					fi
					arg=`echo $arg | sed "s/\b$2\b//g"`
					#echo $arg
				fi
				;;
			-shared )
				default_mode_activated=-1;;
			-c )
				default_mode_activated=-1;;
			-static )
				default_mode_activated=-1;;
			-wi4mpi_static )
				arg=`echo $arg | sed "s/-wi4mpi_static//g"`
				default_mode_activated=-1
				static_compilation=1;;
			-showme:compile | -showme:link | showme )
				showme; exit 0
				;;

esac
shift
done
extra_arg=""
if [[ default_mode_activated -eq 1 ]];then
	default_mode
	${WI4MPI_CC} -c wi4mpi_libs_default_paths.c -o wi4mpi_libs_default_paths.o
	extra_arg=wi4mpi_libs_default_paths.o
	source_default_mode
fi
if [[ static_compilation -eq 0 ]];then
${WI4MPI_CXX} -I${WI4MPI_ROOT}/include -L${WI4MPI_ROOT}/lib -lmpi "$arg" $extra_arg
else
${WI4MPI_CXX} -I${WI4MPI_ROOT}/include "$arg" $extra_arg ${WI4MPI_ROOT}/lib/libmpi.a 
fi
exit $?
